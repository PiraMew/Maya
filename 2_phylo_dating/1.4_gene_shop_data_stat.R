#!/usr/bin/env Rscript
###########################################################################
# Project: Orania Phylogeny MT
# Script: gene_shop_data_stat.R
# --- Action: Compares gene trees to Astral tree (one direction) in order to 
# ------------ select the genes that have the least "good" (BS > 75%) nodes disagreeing with the tree of individuals (i.e. "species tree"). Also select among these selected genes the most clock-like genes.
# --- Input: species tree, folder with individual rooted gene trees (with outgroup! + collapsed nodes (BS < 10) and collapsed nodes (branch length < 0.00002))
# --- Output: sorted statistic based on the signal_support_stats function of the script gene_shop_fct.R and selected genes for different scenarii
# Author: Maya Schroedl
###########################################################################

rm(list=ls())

# Functions ------------------------------------------------------------------
source(file.path(getwd(), "scripts", "2_phylo_dating","1.4_gene_shop_fct.R"))


# Libraries ---------------------------------------------------------------
if (!require('dplyr')) install.packages('dplyr'); library('dplyr')


# Working directories -----------------------------------------------------
wd = getwd()

# Application ------------------------------------------------------

### Input ---
## Rooted gene trees ----
genetrees_folder = file.path(wd, "2_phylo_dating", "2_astral_gene_trees","gene_trees_drop") #where are the gene trees
gene_list = read.table(file.path(wd, "1_phylo_reconstruction", "genelist_7575.txt"))[,1] #list of all the genes
suffix = "_drop.tree" #how are the gene tree files named
 
## Rooted species tree ----
sptree_file = file.path(wd, "2_phylo_dating","2_astral_gene_trees","astral_for_dating.tree" ) #where is the species tree

sptree = read.tree(sptree_file) #read species tree

### Output ----
gene_shop_dir = file.path(wd, "2_phylo_dating","3_gene_shop")
if (!dir.exists(gene_shop_dir)){dir.create(gene_shop_dir)}
### 
output = file.path(gene_shop_dir,"geneshopping.stats")

#### Get statistics ----
if (file.exists(output)){file.remove(output)} #delete output file
for (gene in gene_list){
  genetree = read.tree(file.path(genetrees_folder,paste0(gene, suffix)))
  #genetree$edge.length = NULL #make relations better visible (remove branch lengths for this analysis)
  #plot(genetree, main = gene) #have a look how tree looks
  #nodelabels(text=genetree$node.label,frame = "none") #add bootstrap support
  
  signal_support_stats(genetree,gene, sptree, output)
  
  }

#### Select genes ----

# get statistics for each gene generated
stats=read.table(output, h=T)

stats_sorted = stats %>%
  arrange(gnd_disagree_perc, desc(gnd_agree_perc))

View(stats_sorted)

#######################
# we would like to chose the genes that have:
#   - the least good nodes disagreeing with sptree
#   - the most clocklike
################

# 1) Genes with 0 disagreeing good nodes
no_gdis = stats$genetree[which(stats$gnd_disagree_perc == 0 & stats$gnd_agree_perc != 0)]


# 2) possible clock-like gene (having 0 disagreeing good nodes). This gene needs to be tested with Bayes factor beast (nested sampling), to see whether it really clock-like and can be run with a strict model or not.

#sort stats by ascending root-tip variance
stats_clock = stats[which(stats$genetree %in% no_gdis),] %>% #only have a look at no_gdis genes
  arrange(root_tip_var)

one_clock = stats_clock$genetree[1] #the "best" gene


# Write names of selected gene to files -------------------------------------------
selected_dir = file.path(wd,"2_phylo_dating","3_gene_shop","selected_genes")
if (!dir.exists(selected_dir)){dir.create(selected_dir)}

write.table(no_gdis, file.path(selected_dir,"no_gdis.txt"),col.names=F,row.names = F,quote=F)
write.table(one_clock, file.path(selected_dir,"clock_one.txt"),col.names=F,row.names = F,quote=F)

