# Dating the phylogeny
### Preparation of alignments

#### **`1.1_add_empty_seqs_for_sp.py`** 
Empty sequences need to be added to the alignments for the TAGs (individuals) which did not have a sequence for the corresponding gene (because no reads were recovered with HybPiper). This custom script does this using [Biopython](https://biopython.org/) v1.7.5.

#### **`1.2_concatenate.sh`**
Concatenates alignments with [phyx](https://github.com/FePhyFoFum/phyx/) v3.0.

1. First, all alignments were concatenated. 
1. Then the script `1.3_get_best_indiv.R` was used to chose one or two individuals per species for dating (see below) and the not selected individuals were removed from the concatenated alignments. This resulted in the dataset 1 (all genes)
1. In a next step, genes that had no well-supported nodes (BS > 75%) disagreeing with the species tree were selected, and also it was tested for clock-likeness on one gene. This was done with the scripts `1.4_gene_shop_fct/data_stat.R` (see below).  These selected genes were concatenated (once for the "least-topology-conflict" genes, and once for the most clock-like gene)
1. Then the individuals which were not chosen in step 2 were removed for the concatenated alignments of the selected genes. This resulted in the dataset 2 (selected genes)

#### **`1.3_get_best_indiv.R`**
For the species where more than one individual was available (and the individuals were monophyletic in tree of individuals), only one individual was chosen, i.e the individual with the alignment that had the least gaps.

For the species where more than one individual was available, but these individuals were not monophyletic (in tree of individuals), one individual of each group was chosen. For those individuals that were monophyletic within this not-monophyletic species, the individual with the alignment that had the least gaps was chosen.

In the tree of individuals, the tips of the not-chosen individuals were dropped, so this tree could be used as backbone (starting tree & multimonophyletic constraint) for the dating.

#### **`1.4_gene_shop_fct.R`**

This script generates different statistics on topology conflict (genetree-sptree) and clock-likeness for each gene tree:

* **gnodes_perc**: percentage of "good" nodes (weighted by polytomies)
* **nd_agree_perc**: percentage of nodes that agree with sptree (weighted by polytomies)
* **nd_disagree_perc**: percentage of nodes that disagree with sptree (weighted by polytomies)
* **gnd_agree_perc**: percentage of nodes that are "good" nodes and agree with sptree (weighted by polytomies)
* **gnd_disagree_perc**: percentage of nodes that are "good" nodes and disagree with sptree (weighted by polytomies)
* **gnd_disagree_nbr**: number of "good" nodes that disagree
* **diff_ga_gd**: difference between percentage of agreeing and disagreeing "good" nodes
* **root_tip_var**: root-tip-variance indicating "clock-likeness"

The percentage statistics were weighted by polytomies as follows: a node with a polytomy gets assigned a certain weight depending on the number of branches connected to this polytomy. A trichotomous node gets a weight of 2, a node with 4 branches going out from its polytomy a weight of 3, etc. The percentages are no calculated on the weighted corresponding values divided by the theoretical number of nodes. The theoretical number of nodes of a tree corresponds to how many nodes it would have if the tree was fully resolved.

This statistics build a base or the selection of genes with the script `1.4_gene_shop_data_stat.R`.

#### **`1.4_gene_shop_data_stat.R`**

In order to avoid possible bias in branch lengths through topological and rate heterogeneity across genes, this script selects genes, whose gene trees have the least topological conflict with the species tree, and in a second step clock-likeness was tested for one gene.

This was done based on Smith & al. 2018, but in addition to that the present selection takes into account node support and chose the genes that had no well-supported nodes (BS > 75%) disagreeing with the species tree.

This script first applies the function of script `1.4_gene_shop_fct.R` for all gene trees to get statistics for each gene tree. 

Then, it selects the genetrees with 0 disagreeing "good" nodes (BS > 75%) (selected genes)

In a second step, one gene was selected which has the smallest root-tip-variance (and 0 disagreeing good nodes), i.e. is the most "clock-like". It has to be tested whether this gene is really clock-like. This was done with BEAST using the nested sampling algorithm
and model selection based on the Bayes factor (with [this tutorial](https://taming-the-beast.org/tutorials/NS-tutorial/NS-tutorial.pdf) in BEAST), with the .xml file which will be generated by the script `2_beauti_babette.R`.


### Preparation of .xml file

### **`2_beauti_babette.R`**

This script generates a .xml file containing all the parameters which will be needed for dating with BEAST. This is usually achieved with the [BEAST integrated GUI BEAUti](https://beast.community/beauti). However this is neither reproducible, not very "clean". This is where I found the wonderful R package [**babette**](https://github.com/ropensci/babette) by Richard Bilderbeek, which includes almost all options of BEAUti. 
So, the .xml was created with babette v2.1.2 for the two different datasets (all genes, selected genes) and also for the nested sampling.

Unfortunately, babette does not contain an option to add a multimonophyletic constraint, so this was added manually. The mutlimonophyletic constraint was the ASTRAL species tree with dropped tips of the non-selected individuals. Branchlength values need to be manually removed (I found no better way...). Furthermore, the chronopl starting tree (see `2.1_chronopl_starting_tree.R`) had to be also added manually to the .xml file.


#### **`2.1_chronopl_starting_tree.R`**

This script uses the function `chronopl` of the package **ape** to "scale" the ASTRAL tree with branchlengths to the calibration point in order to get a starting tree that has approximately the right time scale. This method follows [this article](https://justinbagley.rbind.io/2013/10/10/off-to-a-good-start-how-to-generate-starting-trees-for-beast-analyses-using-r/).


### Dating

### **`3_beast.sh`**
Just a very very small example script on how [BEAST](https://beast.community/) v2.6.1 was run on the cluster [GenomeDK](https://genome.au.dk/) with slurm.


### Bibliography

**Smith, B.T., Harvey, M.G., Faircloth, B.C., Glenn, T.C., & Brumfield,
R.T.** 2014. Target Capture and Massively Parallel Sequencing of Ultraconserved
Elements for Comparative Studies at Shallow Evolutionary Time Scales. *Systematic
Biology*, 63(1): 83--95. doi:10.1093/sysbio/syt061.