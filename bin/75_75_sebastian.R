####
#How to filter loci with 75% of their length recovered in 75% of the individuals
#by Sebastian Escobar
####
wd <- file.path("D:/ONEDRIVE_AU/OneDrive - Aarhus Universitet/Orania_project/2_hyb_align_reconstruction/3_phylogeny_reconstruction/75_75") 
#Here, set the file name of the table generated by get_seq_lengths.py
sample.filename1 = file.path(wd,"seq_lengths_or.txt")
sample.filename2 = file.path(wd,"seq_lengths_orscldyp.txt")
sample.filename3 = file.path(wd,"seq_lengths_sclpod.txt")

sample.filename="D:/ONEDRIVE_AU/OneDrive - Aarhus Universitet/Orania_project/2_hyb_align_reconstruction/AU_server/1_hybpiper/dyp/seq_lengths_dyp.txt"

#use their script to import to ensure correct ref lengths
sample.data1= as.matrix(read.table(sample.filename1,header=T,row.names=1,sep="\t"))
sample.len1 = sample.data1
sample.data2= as.matrix(read.table(sample.filename2,header=T,row.names=1,sep="\t"))
sample.len2 = sample.data2[2:length(sample.data2[,1]),]
sample.data3= as.matrix(read.table(sample.filename3,header=T,row.names=1,sep="\t"))
sample.len3 = sample.data3[2:length(sample.data3[,1]),]

sample.data=rbind(sample.data1,sample.data2,sample.data3)

sample.data= as.matrix(read.table(sample.filename,header=T,row.names=1,sep="\t"))


#set length of reference exon
reference.len = as.numeric(sample.data[1,])

#extract only sample exon lengths
sample.len = sample.data[2:length(sample.data[,1]),]

#calculate percentage of exon recovered for each exon in each individual
percent.len= sweep(sample.len, 2, reference.len, "/")
percent.len = ifelse(percent.len>1,1,percent.len)
percent.len.0.75 <- percent.len

# if percentage exon length recovered is >= 75% make value 1
# if not make value 0
percent.len.0.75[percent.len.0.75>=0.75] = 1
percent.len.0.75[percent.len.0.75<0.75] = 0

#For each exon calculate number of individuals with >= 75% of exon
col <- colSums(percent.len.0.75 != 0)

#Calculate % individuals with >= 75% of exon for each exon
col <- col / (length(sample.data[,1])-1) # -1 for meanlength
head(col)
table(col>=0.75)

#Extract only 75_75 exons from original dataset
length7575<-sample.data[,col>=0.75]

#Density plot of exon lengths with rug of actual exon lengths
d <- density(as.numeric(length7575[1,])) 
plot(d)
rug(as.numeric(length7575[1,]), ticksize = 0.03, side = 1, lwd = 0.5, col = par("fg"),
    quiet = getOption("warn") < 0)

#Get a list of names of 75_75 exons
fam<-names(length7575[1,])

genelist<-read.table(file.path(wd,"2_hyb_align_reconstruction","AU_server","genelist.txt"),stringsAsFactors = F)$V1

not75_75=genelist[!genelist %in% fam]

write.table(fam,file.path(wd,"dyp_7575.txt"),quote=F,row.names=F,col.names=F)

write.table(not75_75,file.path(wd,"dyp_not7575.txt"),quote=F,row.names=F,col.names=F)

